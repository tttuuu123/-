# 我在有赞做小程序性能优化
我20年年底入职有赞，那会有赞前端还有一个大中台，里面有很多技术大佬。那会有赞的C端业务主要包含微信小程序、H5、支付宝小程序，同时还支持QQ小程序、百度小程序等，现在又新加了小红书小程序、抖音小程序。这么多的业务域，中台自然想到一套代码多端复用来提高生产效率。在这样的背景下，诞生了两个框架，一个是中台化框架Ranta，一个是多端框架Tee。

## 有赞中台化框架
Ranta自身就是一个发布订阅模式的框架。每个页面可以看作一个个块级元素堆积而成，Ranta将每个区块叫做extension（简称ext），负责e模块初始化以及模块间的数据传递。那么当模块多了，每个模块提供的数据如果有冲突呢？模块需要在自己的文件夹内声明一份JSON配置文件，将自己提供（provide）和消费（consume）的数据、组件、事件、方法写清楚，Ranta会讲当前页面引入的所有模块的配置放到一个公共池子里，只要某个模块消费的内容在池子里有就直接使用，如果出现重名，那么还提供了别名（alias）和手动绑定的功能。理想情况下，业务开发的模块足够多后，某些新功能页可以使用已有的模块快速搭建而成。

Tee是一个类Vue2框架，主要是利用Vue2的Observer模块对数据做好响应式处理，同时不同端下数据的依赖收集有所区别，譬如在H5下就是一个完整的Vue2，响应式的目的就是为了收集DOM可能发生变化的组件；而在微信小程序下，响应式的目的是为了收集当前组件下数据变更的path。最后在批量异步更新阶段，所有renderWatcher出队列执行时，继续对不同端做不同处理，譬如在H5下依旧是个完整的Vue2，后续走生成虚拟DOM，patchDOM节点流程；而在微信小程序就直接对所有值发生变更的data执行`wx.setData`。

## 框架的问题
这2个框架的落地推动是在21年3、4月份开始，那会我参与了交易下单页中台化，算是内部第一波接触中台化开发的前端。7月份中台开始全面推动中台化，当时我所在的零售部门负责一个叫做点单宝的业务域，在小程序内主要呈现是一个货架点单页，我们也将其中台化了。

如果所有框架的终极目标都是性能无限逼近原生，那么当时我们的两个框架在微信小程序内的性能体验是比较糟糕的。这主要有两方面的原因：一方面是框架自身的问题：

### Ranta的问题

Ranta最初的定位就是一个三方框架（而不是内部框架），对开发的限制过多，依赖配置，且配置规则非常细致，都是一一映射的，当页面内模块多了，配置文件体积就会无限增大，那么初始化导入这份配置就很慢（最初是从远程拉取的）。同时最初配置规则是开发手动维护，就算后续提供了一个VSCode插件FX，可以可视化绑定配置关系，由于框架迭代过程中配置文件格式会变更（中台框架组的设计），引入了一些breakchange，那段时间的中台化开发非常麻烦。

### Tee的问题

Tee作为一个多端框架，提供的是类Vue2语法，所以天然就支持props、data和computed3种响应式数据。这在H5下没有任何问题（H5下就是一个完整的Vue2），但是小程序内并没有render函数生成虚拟DOM并进行依赖收集的过程。Tee的做法是将props、data和computed合并为一个对象（下文称这个对象叫做reactivityObj），在renderWatcher执行时（在微信小程序内就是调用wx.setData(reactivityObj)），会深度遍历一遍这个对象，获取每个对象的值，这个过程就是在做依赖收集。这样处理有几个问题：一是没有做到按需setData，如果开发者没有相关意识，很容易让许多渲染无关的数据参与setData；二是computed属性可能会依赖props，而响应式设计下天然会在微任务内执行setData，所以为了保证数据的一致性，Tee并没有提供原生props，而是把props和data、computed属性一起三合一参与setData；三是微信小程序的Page和Component本质上是导出一份Option（所以天然支持封装），而Tee作为一个运行时框架，会对其做一层封装，那么Tee提供的Page、Component内的this实质上是Tee的实例，这是运行时才能确定的内容，所以Tee没有提供原生data属性，因为data内定义的数据可能会依赖this，而只有运行时Tee才能提供实例，那么初始化阶段必然要执行一次额外的setData，肯定会慢。

## 开发的问题
整个中台化的过程从我的视角看是比较仓促的，尤其没有沉淀出一些最佳实践，大多数开发都是基于自己的认知来写代码，我见过不同团队写出风格完全不同的代码。当时交易团队对于模块的拆分粒度就非常细，一个弹窗组件可能会拆分为Header、Body、Footer3个模块；而我在的零售团队则是按照业务范围定义来拆分模块，我们的货架小程序页被拆分为了店招模块、商品列表模块、商品模块、sku模块、购物车模块。而对于多端框架Tee，当时我们大体是按照Vue2的思维去开发的，computed属性确实对于开发来说非常便捷。

事后看这些开发方式对性能影响是巨大的。

## 性能优化的契机
22年所有业务都完成中台化后并给商家提审到小程序中台化版本后，商家开始陆续反馈微信小程序（后续文章小程序都特指微信小程序）性能卡顿明显。也就是那时起，中台发起了自上而下的性能优化。我全程参与了点单宝点单页性能优化，过程上可以分为三个阶段：
* 22年7月-9月：第一波优化，主要目标P90机型首开小于4s；
* 23年2月-4月：第二波优化，主要目标是P90机型首开小于2s，加购小于1s，商品列表在数量1000下可以流畅使用；
* 23年5月至今：有赞大裁员，中台没了。但各个业务线负责的业务域的性能优化仍在继续，在这个阶段，我把点单宝首开优化到到了1s内；

除了第一阶段我是参与者，点单宝点单页后续几乎所有性能相关优化都是我独自学习、思考、实践出来的，现在我可以说我是半个性能优化专家，为什么说半个，因为性能优化除了涉及业务代码、框架原理、人机交互、接口外，还包括打包产物、网络协议、服务器等，能学习要学习的东西太多了。

性能优化不是一蹴而就的，而是不断得在现有的基础上小步迭代，通过不断尝试寻找最佳实践。后续的文章里，我会尽可能还原这三个阶段，框架做了哪些迭代提高性能，我做了哪些提高性能。