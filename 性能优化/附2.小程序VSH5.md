# 我在有赞做小程序性能优化
有不少人会觉得小程序内的优化可能不适用于H5。我认为这是一个错误的看法，实际上小程序框架结合了Web技术和客户端技术，很多Web中性能优化的方式同样适用于小程序，反过来也一样。

## 浏览器页面为什么卡顿
现代浏览器都是多进程架构，而我们写的HTML、CSS、JS都是在渲染进程内解析、执行和渲染的。但是渲染线程和脚本线程是互斥的，这就决定了渲染和脚本执行只能交互执行。我们常见的卡顿主要原因就是一帧内脚本执行时间过长，导致渲染时间不够，超过了一帧的时间。

## 小程序架构
小程序自身是运行在微信客户端WebView中的，同时为了解决常规网页开发渲染线程和脚本线程是互斥的问题，小程序采用了双线程架构——渲染层和逻辑层分离，两个线程间靠native层（微信客户端）桥接通信。

### 小程序架构的优/缺点
这样做的优点很明显：
* 提高用户体验：UI和逻辑分别跑在两个线程，可以同时渲染或执行逻辑，避免页面长时间的阻塞（这也是为什么在小程序内对DOM节点做按需加载收益并不会很高的原因）
* 安全性：用户的代码都在逻辑层执行，除了使用特定API，无法直接获取到渲染层的DOM（渲染层被隔离）
* 无法使用一些常见库：因为无法获取`DOM API`和`BOM API`，所以类似`Zepto`等库是无法使用的

当然也有缺点。既然小程序双线程间依赖事件来通信，那么就存在通信成本。

### 双线程通信方式
* 渲染层向逻辑层通信

开发者在WXML文件中给DOM绑定事件，文件在编译阶段会生成对应虚拟DOM，在执行阶段渲染层对解析虚拟DOM，事件最终以attr属性的形式生成到虚拟DOM中。渲染层触发用户与DOM的交互时，会将数据从渲染层发送到逻辑层，逻辑层执行对应交互事件绑定的回调。

* 逻辑层向渲染层通信

逻辑层数据发生改变时，通过setData方法将数据发送到逻辑层。

## 小程序 VS H5
### 资源加载
小程序自身是运行在客户端WebView中的，以小程序中切换页面为例，流程是：
1. 新建WebView
2. 注入视图层的小程序基础库
3. 注入主包的公共代码（独立分包除外）
3. （若页面位于分包中）注入分包的公共代码
4. 注入页面代码

可以看到页面初始化阶段主要做的就是公共资源和（如果页面在分包中）页面资源注入，而这部分通过配置预加载规则，基本可以做到资源加载0耗时。

H5页面初始化过程就是一个常见的问题：**从输入URL到页面展示，这中间发生了什么**。常规资源请求流程是：
1. 请求HTML文档，同时HTML解析器将接收到的HTML字节流转为DOM结构
2. 解析存在外部JS文件或CSS文件，发起请求下载对应文件

可以看到H5时一定存在资源加载耗时的，哪怕使用HTTP2的服务端主动推送功能，在请求HTML文档资源时，服务端把对应JS和CSS资源也一并返回，也需要一定时间。

在资源加载这块小程序天然有一些优势。

### 首屏渲染
以小程序中切换页面为例：
1. 资源注入
2. 逻辑层页面初始化
3. 将页面initData发送到渲染层
4. 页面渲染

小程序页面的初始化必须要等运行时资源初始化完毕，并且存在一次初始化数据从逻辑层发送到渲染层。

H5首屏渲染：
1. 构建CSSOM
2. 如果JS文件没有配置`async`或`defer`属性，等待JS执行（JS可能会修改CSS）
3. 继续构建DOM
4. 生成布局树
5. 页面渲染

自数据驱动这个理念在前端流行之始，前端开发页面都依赖一个运行时框架，必须等这个框架的JS资源加载完并初始化，页面才能渲染，这会带来一定的白屏影响。当然H5可以采用SSR来解决首开白屏的问题。

在首屏渲染阶段H5是具有一定优势的。

### 首开相关接口请求前置
小程序的一个特点就是可以提前（在上个页面）发起请求，这一点上小程序有很大优势。

### 数据驱动
现代前端框架都围绕数据驱动的理念，降低开发门槛，H5主流框架和小程序都采用这个理念。

在小程序上修改数据需要使用特定api——setData，一次setData的完整流程是：
1. 逻辑层虚拟DOM树的遍历和更新，触发组件生命周期和observer等
2. 将data从逻辑层传输到视图层
3. 视图层虚拟DOM树的更新、真实DOM元素的更新并触发页面渲染更新

其中由于小程序的双线程架构，数据传输是异步的。但是很多人忽略了一点（认为setData是异步的），setData的整个流程中是半同步、半异步，同步指的是逻辑层虚拟DOM树的解析、data数据的序列化、推入消息队列这个过程是同步的，而数据从逻辑层传输到视图层以及后续视图层渲染更新是异步的。既然涉及到序列化，那么明显只要data数据变大，耗时就会显著增加。

而浏览器内，改变数据后，主流框架会比对虚拟DOM变更映射到真实DOM上，也就是在diff阶段实时操作DOM。对比小程序少了序列化和通信的耗时。

H5内修改数据，DOM变更会比小程序快很多。

## 总结
如果把小程序看做一个运行在客户端WebView内的框架，它的优势是资源加载更快、核心接口可以提前请求，但是在H5上可以用SSR来抹平相应劣势，同时在后续数据变更影响页面渲染上H5的性能明显比小程序更高。

除此之外，小程序和H5很多地方是相似的，它们都是在浏览器内渲染的，常见的优化手段，诸如极致的‘懒’、面向框架编码、网络请求优化（减少接口请求数量、降低接口请求耗时）、缓存对它们都是有效的。

这些优化手段的本质就是减少关键路径依赖的资源的量，在这一点上，所有优化手段都是殊途同归的。

