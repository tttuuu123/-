# 我在有赞做小程序性能优化
到写这篇文章截止，再过3个月，就在有赞工作满3年了。除了入职第一年赶上有赞最好的时期，一直在迭代各种业务，后两年很多时间都在做性能优化相关的事，从踩过的一个又一个坑中，一点点学会性能分析，针对优化，从各个业务的性能首开报告上看，我优化过的小程序页面在有赞应该是首开性能最好的。

在最后的总结中，我想谈一谈做性能优化的收获和一些见解。

## 一口吃不成一个胖子
曾经当把点单页优化到4s，我觉得已经很牛逼了；当把点单页优化到2s，我觉得已经到极限了；现在优化到了1s，我觉得还有优化空间。

这可能是有赞的性能优化目标制定合理的地方，没有一开始就定下一个**无法企及的雄心壮志**。

每次定一个需要努力才能勾到的目标，是对一个人成长有益的方式。

## 由浅入深，了解框架
在第一、二阶段优化中，我反复提到了当时面临的最大问题是经验不足，找不到优化点，我们也走了很多弯路，这就像交的学费一样，每个人都是从失败中慢慢成长。

最初我们希望利用优化H5的经验（这个网上有很多相关文章）以及对Vue的理解（我们对Vue有深入的理解）来优化，这条路有一些是正作用，比如懒加载，比如图片压缩；有一些是副作用，比如大量使用computed属性。

我认为当时我们踩这些坑的主要原因还是在于我们的思维没有转变，我们是在优化小程序，优化一个经过自研框架封装后的小程序代码。而我们寄希望于通过对另一种相似技术的理解能大幅优化小程序性能，这实际上是把路走窄了。

这也是后来我为什么要去研究自研框架和小程序的架构。如果只是为了完成业务需求，那么会用框架Api即可；只有了解了框架怎么运行，才能针对性的去做定制优化。

## 构建自己的知识模型
说到小程序的架构，大多数接触的人都知道微信小程序是双线程架构，中间靠native层通信，大多数人也仅仅停留在知道这一层。

发散一下，我们可以从中解读出多少信息呢？
* 小程序依旧有脚本线程和渲染线程，是用js语言写的，有界面，所以大概率小程序是跑在一个Webview中的；
* 小程序双线程分离的架构决定了脚本线程和渲染线程是可以同时运行的，那么渲染相同数量的DOM节点，小程序会比H5有些优势，也就是说，减少DOM节点数量的优化在小程序内影响不会那么明显；
* 开发代码其实都在逻辑层运行，开发无法直接操作到渲染层，也就是说小程序内对DOM节点的操作成本很高，且一定是异步的；
* 同样的，由于依赖native层通信（通信通信，只能是字节流），那么如果我们要传输一个对象，就需要先进行序列化转为字符串，并且数据传输时间与数据大小正相关，所以在小程序内，setData是运行时开销成本最大的Api，要优化好小程序，就一定要优化好setData的使用；
* 双线程的架构还意味着，用户的操作反馈也是异步的，比如我们在小程序上点击按钮，实质上是在渲染层触发了一个点击的原生事件，但是因为业务代码在逻辑层，这个事件必须通过通信传输到逻辑层，并且一定经过一套事件分发机制传输到指定业务代码处执行；

显然的，我是基于我对于微信架构的认知，才能发散出这么多信息，这其实就是在串联我们掌握的知识，串联的知识多了，也就构建出了知识模型。同样的，当能构建出知识模型，某种程度才能证明真正掌握了这块知识。

## 性能优化的方法论
有了成功的经验后，性能优化真的很简单。

以小程序为例：一是想办法让接口耗时接近0；二是控制setData的数据（只与渲染目标有关）大小和频率。做到这两点页面的性能就差不了。

再进一步总结就是就是**减少关键路径依赖的资源的量**。

这在H5下也是一样的，比如H5首开优化中常用的SSR，实质就为了让首开不在依赖框架的运行时（从H5的首开链路剥离了框架运行时的因素）。
