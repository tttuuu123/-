# 我在有赞做小程序性能优化
22年7月在完成点单宝点单页中台化后，真机测试下来从首开点击自提按钮跳转到点单页商品图片渲染完毕，P90分位首开时间是7s，无疑是商家无法接受的。

## 现状
有赞前端18年左右就引入了Node，但是对于Node的定位基本属于胶水层，后端提供原子接口，前端通过Node封装成C端使用接口，在Node层不基本不做数据处理，而逻辑的承载自然都在C端。
点单宝（当时还叫做24小时货架）是20年疫情期间开发的新功能，和市面上大多数点单小程序类似，页面由几个明显的模块组成：
* 店招模块：包含店铺信息、配置方式、营销信息
* 商品列表模块：左侧导航，右侧商品列表
* 购物车模块

当时点单宝的代码就是业务的堆砌，按照产品需求从0写到10，也就是说架构层面并没有一些规划。中台化是在22年7月，那个时间点正是有赞巅峰，业务需求非常多，迭代非常快，为了完成中台化，前端TL说服了产品等其他团队伙伴，前端ALL IN中台化，一个月内完成，这一个月不接任何需求，所以前端团队压力也很大，中台化主要做的事就是代码的翻译，保证功能没问题，加之团队成员基本都是第一次接触中台化，并没有通过这次中台化重构把代码梳理清晰。

9月份启动的性能优化，当时owner是我的小组长，后来的TL——技术、能力、为人都非常牛，就这样，我们迈出了性能优化的第一步。下面我会记录一下当时我们做性能优化的方向/思路，当然由于整个团队都没有多少性能优化经验，尤其是中台化下的优化经验，也没阅读过框架源码，不少方法现在看都是做的负优化。

## 用H5的思维做优化——懒加载与按需加载
我们都知道浏览器Perfermance面板内分析，主要时间在做2件事，执行脚本scripting和渲染rendering，卡顿的主要原因就是一帧内执行时间过长，导致渲染时间不够，就出现了我们常说的掉帧。那么让脚本执行时间缩短，要渲染DOM节点减少，性能一定会提升。

那么按需是大家都能想到的事。我们把所有DOM节点排查了一遍，能按需加载的都按需，同时对应组件的初始化逻辑也放在第一次按需渲染的时间点，如果某些组件的初始化涉及到接口请求，那么就会把返回结果用Promise包一层，后续从Promise拿。这样我们在首开链路中减少了部分DOM节点渲染、逻辑执行和接口请求。但实际上这是一个投入大收效小的举措，通过跑数据发现性能提升大概只有百毫秒的样子，而我们的改动涉及到代码的方方面面，非常琐碎。

商品列表上，商家上传的商品图片有些会很大（几百k），我们通过cdn处理把图片压缩为2倍图，生产环境测试图片加载能快约50ms。

## 用Vue2的思维做优化——大量使用computed属性
当时团队我们组的成员之前大部分都是Vue技术栈的，对Vue源码了解的比较多，正巧Tee是一个类Vue框架，很自然的会往Vue上多想想。而小程序性能优化的一个重点就是控制`setData`的频率和数据大小，那么Vue中computed属性天然具有**懒的特性**，所以当时我们期望通过computed属性来帮助我们减少`setData`中不必要的数据。

现在看这是一个明显得负优化，反而导致首开时间增加了不少。至于为什么使用computed性能糟糕，我们后续又怎么优化的在后续文章内分析。

## Node多走一步——接口聚合
### 商品接口链路聚合

之前由于业务快速迭代，某个环节可能迭代了多次，每次都可能需要新增一些接口逻辑，这部分逻辑基本都是在C端累加，也就可能造成某个链路需要在C端串行调用几次接口。当时商品列表是按照分组维度请求的，先请求分组的商品列表数据，再请求库存数据（小程序内是网店，要查供货点的库存），再请求履约时效，整个流程需要发起3次HTTP请求，整个商品列表链路的请求时间是1.6s。我们重新在Node层包了一个接口，先请求商品列表数据，拿到商品id集合后，再并行请求库存和履约时效。这样通过减少两次通信，以及两个接口串改并，整个商品列表请求时间降低到了1.2s。

### 首开相关接口聚合

同时商品列表的请求时机是在点单页相关配置初始化完成后，而点单页初始化配置关联了十多个接口，这些接口都在首开流程内依次去执行，那么就有两个问题：一是小程序自身相当于一个浏览器，接口最大请求并发数是有限制的，这么多接口都要发起HTTP请求，后续接口只能是pending状态在队列中等待；二是平白增加了多次客户端到服务端的通信时间。我们重新在Node层包了一个接口，命名叫pageConfig，所有首开需求的数据都放到这个接口中请求，小程序内拿到这部分数据后再开始初始化。

接口层面这2个改动，对性能提升挺明显的。这也是我们对让Node承担更多功能做的一个初步尝试。

## 小程序自身
### 配置preoload规则

点单宝点单页的入口在社电的首页里，由于一些未知原因，之前没有允许点单宝在首页配置preload规则。在这次优化中也是说服了中台在首页给点单宝配置了preload规则，这对点单宝点单页首开提升也很明显。

### 下掉老页面

同时之前点单宝中台化开发阶段我们是新建了一个分包，上线阶段为了实现软着陆，老分包代码并没有删除（所有商家后台跳链链接都是老分包地址），而是在Redies内配置了一个开关，在老分包内写了一段代码读取这个开关，如果开启就重定向到新分包路径，所以首开阶段存在一次额外的一次分包跳转（小程序首次分包跳转耗时大约是120ms左右）。因为当时点单宝点单页的入口只有首页，首页的数据都是商家后台装修配置出来的，在Node层对装修数据做了一次处理，所有匹配的老点单宝点单页分包地址全部替换为新分包地址，这样就减少了一次分包跳转耗时。

## 总结
第一阶段性能优化做的事现在看都很基础。一是因为之前点单宝代码架构确实很不合理，二是因为我们团队在性能优化方面的经验积累很少，更缺少在小程序架构下的优化经验，这些措施（例如DOM节点按需加载）实际投入了很多人力，但是实际在小程序架构下这些措施并没有带来明显收益（甚至负收益）。最终结果首开优化到了4s，达成预期。

